#installer.py
import os
import subprocess
import time
import sys

def install_packages(files,extra_pkgs):
    base_pkgs = ["linux", "linux-headers", "linux-firmware", "base","sudo", "nano", "grub", "efibootmgr","networkmanager", "plasma-nm", "pipewire", "pipewire-alsa","sddm", "plasma-meta", "konsole", "dolphin", "firefox"] # Required packages
    custom_pkgs = []
    for file in files:
        if os.path.exists(file):
            with open(file, "r") as f:
                custom_pkgs.extend(f.read().splitlines())
    full_list = list(set(base_pkgs + [p.strip() for p in custom_pkgs if p.strip()] + extra_pkgs))
    if not full_list:
        print("No packages selected.")
        return
    print(f"Starting install of {len(full_list)} packages.")
    # Example: pacstrap -K /mnt pkg1 pkg2 pkg3 ...
    """
    try:
        subprocess.run(["pacstrap","-K","/mnt","linux"],check=True)
    except subprocess.CalledProcessError:
        print("Error installing critical module, pacstrap failed and install is terminating.")
        sys.exit(1)
    """
    # We need to install something that's required first so we can activate multilib (create the path)
    """
    sed_snip = r'/^# *\[multilib\]/,/^# *Include/ s/^# *//'
    sed_cmd = ["sed","-i",sed_snip,"/mnt/etc/pacman.conf"]
    try:
        subprocess.run(sed_cmd,check=True)
    except subprocess.CalledProcessError:
        print("Error enabling multilib, terminating installation process.")
        sys.exit(1)
    """
    cmd = ["pacstrap", "-K", "/mnt"] + full_list
    task_start = time.time()
    try:
        subprocess.run(cmd, check=True)
        print("\nInstallation complete.")
    except subprocess.CalledProcessError:
        print("\nError installing, pacstrap failed.")
        sys.exit(1)

    print(f"Total time: {time.time() - task_start:.2f} seconds")

